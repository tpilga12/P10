\section{Preissmann scheme}\label{subse:preissmann_scheme}
In this section the Saint Venant equations are solved using a numerical method. 

%Argument for at bruge numeriske metode til at løse saint venant eq.

The numerical method used for solving the Saint Venant equations, described in section \ref{se:hydraulics_of_sewer_line}, is the Preissmann scheme also known as the box scheme. Other method exist such as, Lax scheme, Abbot-Ionescu scheme, leap-frog scheme, Vasiliev scheme, however the Preissmann scheme is commonly known as the most robust scheme. Basically by using the Preissmann scheme the Saint Venant equations can be discretized, and thereby used in a simulation to calculate the flow and height throughout an open channel.   

From section \ref{se:hydraulics_of_sewer_line} the Saint Venant equations for conductivity and momentum are derived, they are also shown below,

\begin{equation}\label{eq:saintbernard_mass_preiss}
\frac{\partial A(x,t)}{\partial t} + \frac{\partial Q(x,t)}{\partial x}=q(x,t)
\end{equation}

\begin{equation}\label{eq:saintbernard_momentum_preiss}
\frac{1}{gA} \frac{\partial Q}{\partial t} +\frac{1}{gA}\frac{\partial}{\partial x} \left( \frac{Q^2}{A} \right) + \frac{\partial h}{\partial x} + S_f - S_b = 0
\end{equation}

%Skriv noget om boundary og initial conditions

In figure \ref{fig:preissmann_grid_scheme} a single mesh for the Preissmann scheme is illustrated.

\begin{figure}[H]
\centering
\includegraphics[width=.6\textwidth]{report/simulation/pictures/preissmann_scheme}
\caption{Preissmann non-staggered grid scheme.}
\label{fig:preissmann_grid_scheme}
\end{figure} 

Where $\theta$ is a weighting parameter ranging between 0 and 1, j index of section and i index of time. This mesh contains four nodes, (j,i), (j+1,i), (j,i+1) and (j+1,i+1), however in the implementation the dimension of the grid is $\Delta t \times \Delta x$ for $0 \leq x \leq L$ and $0\leq t$. Where L defines the length of the open channel. The derivatives in equations \ref{eq:saintbernard_mass_preiss} and \ref{eq:saintbernard_momentum_preiss} are calculated as approximation at the point P, which is in the middle of the interval of $\Delta x$, and is also the reason why the Preissmann scheme is corresponding to a box scheme. The point P can only move along the t axis within this mesh by adjusting the weighting parameter $\theta$. This weighting parameter will be elaborated on later. An arbitrary function $f_p(x,t)$ calculated at point P is approximated by, 

\begin{equation}\label{eq:approximated_function}
	f_p \approx \frac{1}{2} (\theta \cdot f_j^{i+1}+(1-\theta)f_j^i)+\frac{1}{2}(\theta\cdot f_{j+1}^{i+1}+(1-\theta)f_{j+1}^i)
\end{equation}
The numerical approximation for the derivatives in equations \ref{eq:saintbernard_mass_preiss} and \ref{eq:saintbernard_momentum_preiss} for time and length are shown below, 

\begin{equation}\label{eq:preissmann_time_derivatie}
	\frac{\partial f}{\partial t}\bigg \rvert_p \approx \frac{1}{2}\left(\frac{f_j^{i+1}-f_j^n}{\Delta t}+\frac{f_{j+1}^{i+1}-f_{j+1}^i}{\Delta t}\right)
\end{equation}

\begin{equation}\label{eq:preissmann_space_derivatie}
	\frac{\partial f}{\partial x}\bigg \rvert_p \approx (1-\theta)\frac{f_j^i-f_{j+1}^i}{\Delta x}+\theta \frac{f_j^{i+1}-f_{j+1}^{i+1}}{\Delta x}
\end{equation}

These approximations from equations \ref{eq:preissmann_time_derivatie} and \ref{eq:preissmann_space_derivatie} can therefore be inserted for the derivatives in the Saint Venant equations \ref{eq:saintbernard_mass_preiss} and \ref{eq:saintbernard_momentum_preiss} and thereby achieve the following, 

\begin{equation}\label{eq:continuity_eq_preissmann}
	\theta \frac{Q_{j+1}^{i+1}-Q_j^{i+1}}{\Delta x}+(1-\theta)\frac{Q_{j+1}^i - Q_j^i}{\Delta x}+
	\frac{A_{j+1}^{i+1}-A_{j+1}^i}{\Delta t}+\frac{A_{j}^{i+1} - A_j^i}{\Delta t} = q_p
\end{equation}

% \begin{multline}
% 	\frac{1}{2} \left(\frac{Q_{j+1}^{i+1}-Q_{j+1}^i}{\Delta t}+\frac{Q_{j}^{i+1} - Q_j^i}{\Delta t}\right) + \frac{\theta}{\Delta x} \left(\left(\frac{Q^2}{A}\right)_{j+1}^{i+1}-\left(\frac{Q^2}{A}\right)_{j}^{i+1}\right) + \\ \frac{1-\theta}{\Delta x}\left(\left(\frac{Q^2}{A}\right)_{j+1}^{i}-\left(\frac{Q^2}{A}\right)_{j}^{i}\right)+gA_p\theta \left(\frac{h_{j+1}^{i+1}-h_j^{i+1}}{\Delta x}\right)+ \\ gA_p(1-\theta)\left(\frac{h_{j+1}^{i} - h_j^i}{\Delta x}\right)+\left(\frac{g\cdot n_M^2}{R^\frac{4}{3}}\frac{|Q|Q}{A}\right)_P = 0 
% \end{multline}
\begin{multline}
	\frac{1}{gA_p}\left(\frac{1}{2} \left(\frac{Q_{j+1}^{i+1}-Q_{j+1}^i}{\Delta t}+\frac{Q_{j}^{i+1} - Q_j^i}{\Delta t}\right)\right) + \frac{1}{gA_p}\left(\frac{\theta}{\Delta x} \left(\left(\frac{Q^2}{A}\right)_{j+1}^{i+1}-\left(\frac{Q^2}{A}\right)_{j}^{i+1}\right)\right) + \\ \frac{1-\theta}{\Delta x}\left(\left(\frac{Q^2}{A}\right)_{j+1}^{i}-\left(\frac{Q^2}{A}\right)_{j}^{i}\right)+\theta \left(\frac{h_{j+1}^{i+1}-h_j^{i+1}}{\Delta x}\right)+ \\ (1-\theta)\left(\frac{h_{j+1}^{i} - h_j^i}{\Delta x}\right)+S_f-S_b= 0 
\end{multline}

By discretized the Saint Venant equations they can be used in a simulation to calculate parameters for the open channel model. The mesh shown in figure \ref{fig:preissmann_grid_scheme} is used to calculate the node (j+1,i+1) by knowing the previous values in time and length (j,i), (j+1,i) and (j,i+1). Therefore some initial condition must be known to calculate the parameters for the open channel in the first iteration. The flow, at t=0, must be known throughout the pipe, furthermore the flow that will enter the channel for $t\leq 0$ must be known, as shown in figure \ref{fig:preissmann_grid_scheme_exampel}.   

\begin{figure}[H]
\centering
\includegraphics[width=.6\textwidth]{report/simulation/pictures/preissmann_scheme_exempel}
\caption{Preissmann non-staggered grid scheme example of calculation pattern.}
\label{fig:preissmann_grid_scheme_exampel}
\end{figure} 
%% Dette skal omformuleres
By knowing the flow and parameters for the pipe, the height can be calculated in the initialization nodes, which will be elaborated on later. With equation \ref{eq:continuity_eq_preissmann}, the flow (j+1,i+1) can be calculated by knowing the flow and height in the previous nodes (j,i), (j+1,i) and (j,i+1) as illustrated with the box in the left bottom corner in figure \ref{fig:preissmann_grid_scheme_exampel}.  

For the Preissmann scheme to be numerical stable the $\theta$ parameter is $\theta \geq 0,5$. If $\theta$ is equal to 0,5 the Preissmann scheme is second order accurate in both time and length, and is first order accurate otherwise.   

In the following section the calculating of the flow and height in each node will be explained.

\subsubsection*{Iteration scheme}
In this section the scheme for calculating the flow and height in each iteration will be explained. 

The discretized continuity equation \ref{eq:continuity_eq_preissmann} from section \ref{subse:preissmann_scheme} is solved for the desired flow,

\begin{equation}\label{eq:continuity_solve_flow}
	Q_{j+1}^{i+1} = - \frac{1}{2\theta}\left(A_{j+1}^{i+1}-H\right)\frac{\Delta x}{\Delta t}
\end{equation}

Where H is a parameter where all the previous flows and areas are known,
\begin{equation}
	H = \left(2(1-\theta)Q_j^i-2(1-\theta)Q_{j+1}^i+2\theta Q_j^{i+1}+2q(x,t)\Delta x\right)\frac{\Delta t}{\Delta x}- A_{j}^{i+1}+A_j^i+A_{j+1}^i
\end{equation}


In equation \ref{eq:continuity_solve_flow} the flow $Q_{j+1}^{i+1}$ is a function of the unknown area $A_{j+1}^{i+1}$, and by subtracting the flow on each side the following is achieved, 

\begin{equation}\label{eq:continuity_zero_eq}
		0=-Q_{j+1}^{i+1}  - \frac{1}{2\theta}\left(A_{j+1}^{i+1}-H\right)\frac{\Delta x}{\Delta t}
\end{equation}
By calling the right hand side of equation \ref{eq:continuity_zero_eq} for V the following is obtained,

\begin{equation}\label{eq:continuity_V}
		V=-Q_{j+1}^{i+1}  - \frac{1}{2\theta}\left(A_{j+1}^{i+1}-H\right)\frac{\Delta x}{\Delta t}
\end{equation}

Equation \ref{eq:continuity_V} can now be solved by finding the zero for the function V using newton method. However there are still two unknowns in equation \ref{eq:continuity_V}, $Q_{j+1}^{i+1}$ and $A_{j+1}^{i+1}$. $Q_{j+1}^{i+1}$ can be replaced with the following, 

\begin{equation}\label{eq:calc_for_flow}
 	Q = \left(0.46-0.5 \cdot cos\left(\pi \frac{h}{d}\right)+0.04\cdot cos\left(2\pi\frac{h}{d}\right)\right)Q_f
\end{equation}
Which describes the flow in an open channel by knowing the height, diameter of the pipe and the flow for a fully filled pipe, $Q_f$. $Q_f$ can be found with the following equation, 

\begin{equation}\label{eq:qf_for_flow}
	Q_f = -3.02 \cdot ln\left(\frac{0.74\cdot 10^{-6}}{d\sqrt{d\cdot I_e}}+\frac{k}{3.71\cdot d}\right)d^2\sqrt{d\cdot I_e}
\end{equation}
Where k is a roughness factor found in?? \fxnote{kilde til hvor vi finder den} and $I_e$ is a friction term. Equation \ref{eq:calc_for_flow} is inserted into equation \ref{eq:continuity_V} and thereby the following is obtained,

\begin{equation}\label{eq:V_with_flow}
	V = -Q_f\left(0,46-0,5\cdot cos\left(\pi \frac{h_{j+1}^{i+1}}{d}\right)+0,04\cdot cos\left(2\pi\frac{h_{j+1}^{i+1}}{d}\right)\right)\frac{\Delta t}{\Delta x}-\frac{1}{2\theta}\left(A_{j+1}^{i+1}-H\right)
\end{equation}

Furthermore $Q_f$ from equation \ref{eq:qf_for_flow} is inserted into equation \ref{eq:V_with_flow}, 

\begin{multline}\label{eq:new_continuity_equation}
	V = -72\left(\frac{d}{4}\right)^{0.635}\pi\left(\frac{d}{2}\right)^2I_e^{0,5} \left(0,46-0,5\cdot cos\left(\pi \frac{h_{j+1}^{i+1}}{d}\right)+ 0,04\cdot cos\left(2\pi\frac{h_{j+1}^{i+1}}{d}\right)\right)\\ \frac{\Delta t}{\Delta x}-\frac{1}{2\theta}\left(A_{j+1}^{i+1}-H\right)
\end{multline}

V is a function of the height $h_{j+1}^{i+1}$ as the height is the only unknown in finding the area $A_{j+1}^{i+1}$ for the channel. The area for a circular channel is calculated with the following,

\begin{equation}\label{eq:calc_area_open_channel}
	A = \frac {d^2}{4} \cdot acos \left(\frac{\frac{d}{2}-h}{\frac{d}{2}}\right)-\sqrt{h (d-h)} \left(\frac{d}{2}-h\right)
\end{equation}

As mention the continuity equation \ref{eq:new_continuity_equation} can be solved by finding the zero for the function V. By using the newton method the roots of equation \ref{eq:new_continuity_equation} can be found, which will correspond to the height in the channel. The approximation is,

\begin{equation}
	 (h_{j+1}^{i+1})_{k+1} =(h_{j+1}^{i+1})_{k} - \frac{V_k}{V'_k} 
\end{equation}  

Where k is the number of iterations, V' is the differentiated of V with respect to the height, $(h_{j+1}^{i+1})_{k}$ is an initial guess of the root and $(h_{j+1}^{i+1})_{k+1}$ is new approximate of the height. This calculation will be iterating until a better approximation is achieved which fulfills the requirement,

\begin{equation}
	\left(h_{j+1}^{i+1}\right)_{k}-(h_{j+1}^{i+1})_{k-1} < (\epsilon \cdot h_{j+1}^{i+1})_{k}
\end{equation}

Where $\epsilon$ is a small tolerance number, e.g. 0.05 meters variation in water height. Thereby the water height can be found and therefore the area for the water can be calculated with equation \ref{eq:calc_area_open_channel} \fxnote{afsnit om de forskellige ligninger til beregning af Areal, Ie,Ib,Qf,Q} and thereafter equation \ref{eq:continuity_solve_flow} can be used to calculate the flow for the node.  

This calculation is performed for each node in the Preissmann scheme, therefore it is a iterative method of solving the flow for a open channel. 


In the following figures the flow \ref{fig:simulation_output_flow_height}a and the water height \ref{fig:simulation_output_flow_height}b for the output of the channel is plotted


\begin{figure}[H]
\centering
\begin{subfigure}{.5\textwidth}
  \centering
  \input{report/simulation/tikz/flow_output_simulation}
  \caption{}
\end{subfigure}%
\begin{subfigure}{.4\textwidth}
  \centering
 \input{report/simulation/tikz/height_output_simulation}
  \caption{}
\end{subfigure}
\caption{(a) Output flow, (b) the water height at the output of the channel.}
\label{fig:simulation_output_flow_height}
\end{figure}

These figures shows that whether the height is increasing or decreasing the flow is following, which is what is expected, because a higher water level will result in a higher flow rate and vice versa. 



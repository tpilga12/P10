\section{Implementation \& Verification}\label{sec:implementation_and_verfication}

%In this section the suggested a structure in section \ref{sec:Structure} implemented with the numerical solutions in section \ref{se:preissmann_scheme}-\ref{sec:concentrate}, is tested and verified.
In this section the implementation of the various parts, which the simulation environment consist of, is explained. The chosen structure, which is described in section \ref{sec:Structure}, is seen in figure \ref{fig:Basic_implementation}. 

\begin{figure}[H]
\centering
\includegraphics[width=0.75 \textwidth]{report/simulation/pictures/Basic_implementation.pdf}
\caption{Chosen structure of simulation environment.}
\label{fig:Basic_implementation}
\end{figure}

The first part to be elaborated upon is the initialization.

 \subsection*{Initialization}

For the setup procedure of the simulation in list form, the specifications part shown in figure \ref{fig:sys_setup} needs to be defined. The necessary parameters in the list for both pipe and tank can be seen in table \ref {tab:init_list}. 

\begin{enumerate} \label{tab:init_list}
	\item Pipe
	\begin{itemize}
		\item Length [m]
		\item Sections (Number of sections the pipe should be split in to)
		\item $\text{I}_\text{b}$ (Slope) [\textperthousand]
		\item $\Delta$x = Length/Sections [m]
		\item Diameter [meter]
		\item Theta (parameter used in Preissmann scheme)
		\item $\text{Q}_{\text{f}}$ (maximum flow found by Manning formula, see equation \ref{eq:qf_for_flow}) [$\text{m}^\text{3}/\text{s}$]
		\item Side/lateral inflow present 
		\item Section location in data 
	\end{itemize}
	\item Tank
	\begin{itemize}
		\item Size [$\text{m}^\text{3}$]
		\item Height [m]
		\item Area = Size / Height [$\text{m}^\text{2}$]
		\item Maximum outflow [$\text{m}^\text{3}/\text{s}$]
		\item Section location in data 
	\end{itemize}
	%b\caption{Table of needed parameters for pipe and tank}
\end{enumerate}

Some parameters can be found from others and is set to be calculated automatically. Furthermore an item is added that indicates in which section of the obtained simulation data the specific output of the component is located. This item is given the number of the order in which the component appears in the list. To give an overview of the system to be simulated, and to easily be able to locate specific parameters needed during simulation, three structures is returned to the workspace. These are named ``pipe\_spec'', ``tank\_spec'' and ``sys\_setup''. The first two structures holds the information shown in table \ref{tab:init_list} respectively. The last one, ``sys\_setup'', holds information of the various parts indexed in the order the system is setup and simulated. In figure \ref{fig:sys_setup_matlab} the content of ``sys\_setup'' is shown for a setup with two pipes and a tank.

\begin{figure}[H]
\centering
\includegraphics[width=0.5 \textwidth]{report/simulation/pictures/sys_setup_matlab.png}
\caption{Display of structure holding system setup information in MATLAB.}
\label{fig:sys_setup_matlab}
\end{figure}

An initialization scheme is constructed as per figure \ref{fig:simple_sewer} where adjoint pipes is considered as one part of the system and tank is used as a separator between parts.
The iterative scheme shown in figure \ref{fig:preissmann_grid_scheme_exampel} requires that boundary conditions is found before the iterative Preissmann scheme can be started. It has been decided by the project group that input should be given in flow, as input in height would be needed to be specific for the pipe inserted, to make the simulation universal. This means that from an initial input flow the corresponding height in the pipes needs to be found. By equation \ref{eq:calc_for_flowv2} flow can be obtained from height, but the equation is transcendental i.e. can not be solved analytically for height. This means that other means is necessary to obtain height from flow. A solution to the problem is that for each pipe, during initialization, a data set from zero to the diameter of the pipe in sufficient steps is created, and from which the corresponding flow is obtained by equation \ref{eq:calc_for_flowv2}. From this data a curve fitted polynomial can be obtained by the MATLAB curve fitting toolbox or a lookup table can be constructed. Flow data is generated for 10.000 height steps for a pipe with the parameters shown in table \ref{tab:pipe_figure_parameters}.

\begin{table}[H]
\centering
\begin{tabular}{|c|l|} \hline
Diameter & 0,9 meter \\ \hline
Slope ($\text{I}_\text{b}$) & 3 \textperthousand \\ \hline 
Length & 200 meter \\ \hline
Sections & 10 \\ \hline
 \end{tabular} 
\caption{List of parameters used to obtain data shown in figure \ref{fig:curvefit_comparision}}
\label{tab:pipe_figure_parameters}
 \end{table}

In figure \ref{fig:curvefit_comparision} a comparison is shown of the generated data and a ninth order polynomial fitted to the data.

\begin{figure}[H]
 \centering
 \input{report/simulation/tikz/curvefit_comparison}
\caption{Comparison between data obtained by equation \ref{eq:calc_for_flowv2} and the same data curve fitted to a ninth order polynomial.}
\label{fig:curvefit_comparision}
\end{figure}

The two plots in the figure is seemingly identical, but if observed closer the curve fit has what could be described as a low frequency oscillation compared to the plotted data. Furthermore the curve fit does not reach the same end points. This will result in the height at the end points never to be zero or the diameter of the pipe, when no inflow or maximum inflow is present. In figure \ref{fig:curvefit_comparision_split} the plot is separated into three for an easier overview.


\begin{figure}[H]
 \centering
 \input{report/simulation/tikz/curvefit_comparison_split}
\caption{Comparison between data obtained by equation \ref{eq:calc_for_flowv2} and the same data curve fitted to a ninth order polynomial.}
\label{fig:curvefit_comparision_split}
\end{figure}


 As discussed in section \ref{sec:Structure}, a scheme which brings the system to an initial steady state could be necessary due to the nonlinear nature of the Saint-Venant equations. A test is performed where two adjoint pipes, with the specifications given in table \ref{tab:pipe_figure_parameters}, is calculated for different amount of iterations. The boundary condition is found by the fitted polynomial for each pipe respectively. The result of this test is seen in figure \ref{fig:two_pipes_init_steady_state}. 

\begin{figure}[H]
 \centering
 \input{report/simulation/tikz/two_pipes_init_steady_state}
\caption{Height and flow in two adjoint pipes, with identical specifications given in table \ref{tab:pipe_figure_parameters}, given boundary conditions found by fitted polynomial, and calculated at various amount of iterations with constant flow input of 0,25 $\text{m}^\text{3}$/s. Dotted line indicate intersection between pipes.}
\label{fig:two_pipes_init_steady_state}
\end{figure}

In figure \ref{fig:two_pipes_init_steady_state} a maximum of 22 iterations are performed, as the error between the input flow of 0.25 $\text{m}^\text{3}$/s desired to be in all sections and the calculated flow in all the sections of the two pipes is less than $1\cdot10^{-7}$ which is a preset condition. 
Some discrepancy in heights can be seen at the start of both pipes. These two points are the boundary conditions that are found by the fitted polynomial. Even though the anomalies are small they could pose a problem when expanding the simulation with more pipes and different slopes. 

In figure \ref{fig:Fredericia_pipe_setup} the specifications of the main line of Fredericia mentioned in section \ref{se:system_description}, and given by table \ref{tab:kloak_diameter} with corrections from table \ref{tab:new_slope_values}, is seen.

\begin{figure}[H]
\centering
\includegraphics[width=0.6 \textwidth]{report/simulation/pictures/Fredericia_pipe_setup.PNG}
\caption{Setup in MATLAB of pipe system from section \ref{se:system_description} of main line in Fredericia.}
\label{fig:Fredericia_pipe_setup}
\end{figure}

The amount of sections for each pipe is chosen such that each section is close to being 20 meters, with some sections deviating due to pipe length and others deviates on purpose to see if it affects the outcome.  
In figure \ref{fig:fredericia_init_steady_state} iterations of the pipe setup shown in figure \ref{fig:Fredericia_pipe_setup} is seen. 

\begin{figure}[H]
 \centering
 \input{report/simulation/tikz/fredericia_init_steady_state}
\caption{Height and flow in pipe setup, given by table \ref{tab:kloak_diameter} with corrections from table \ref{tab:new_slope_values}, of part of Fredericia where boundary conditions is found by fitted polynomial. Various amount of iterations, with constant flow input of 0,25 $\text{m}^\text{3}$/s, is performed. Dotted line indicates pipe intersections.}
\label{fig:fredericia_init_steady_state}
\end{figure}

It is clear that the larger setup increases the undesired behavior seen in figure \ref{fig:two_pipes_init_steady_state}. But it can also be seen that the flow can be brought to an acceptable initial state from which the system can start simulating. In figure \ref{fig:fredericia_init_steady_state} a section of the height plot from figure \ref{fig:curvefit_comparision_split} is seen. 
% system needs to be brought in to steady state to negate unintended results when starting simulating.

\begin{figure}[H]
 \centering
 \input{report/simulation/tikz/fredericia_init_steady_state_zoom}
\caption{Segment of the height plot shown in figure \ref{fig:fredericia_init_steady_state}. Pipe 10 and 16 is seen in part at the left and right side and 11 to 15 in between with a red stippled line separating pipes.}
\label{fig:fredericia_init_steady_state_zoom}
\end{figure}

In the above figure, the obtained height from the fitted polynomial is at it worst off by almost a centimeter. But when simulating this offset will only occur in the first section of the pipe. This means that it will be a greater disturbance on short pipes with few sections than larger ones with more sections. An alternative method is attempted to conclude if the deviations of the polynomial fit seen in figure \ref{fig:curvefit_comparision_split} is the cause or if there is an unforeseen error in the Preissmann scheme. A lookup table, where the same data used to create the polynomial fit, is utilized. A simple implementation of it is made where the index in the flow vector is found by subtracting the input flow from the flow vector. The desired index is then found by the index with the lowest absolute value. Finally the resulting height is given as the desired index of the height vector. The chosen scheme for creating the lookup table means that the height will in worst case be less than what it should be. But indexing the flow and height into the chosen 10.000 steps, it is assumed to be an insignificant error, and in worst case the amount of steps can be increased. In figure \ref{fig:fredericia_init_steady_state_lut} an identical test of the pipe setup of Fredericia is performed at various iterations.      

\begin{figure}[H]
 \centering
 \input{report/simulation/tikz/fredericia_init_steady_state_lut}
\caption{Height and flow in pipe setup, given by table \ref{tab:kloak_diameter} with corrections from table \ref{tab:new_slope_values}, of part of Fredericia where boundary conditions is found by lookup table. Various amount of iterations, with constant flow input of 0,25 $\text{m}^\text{3}$/s, is performed. Dotted line indicates pipe intersections.}
\label{fig:fredericia_init_steady_state_lut}
\end{figure}

It is clearly shown that the deviation between the boundary conditions found by the lookup table and the values found iterating the Preissmann scheme is significantly decreased.
Something else to note is that even though the difference seem to be non existent it still required 189 iterations before the flow error were minimized to the same 1$\cdot \text{10}^{\text{-7}}$ as before. For this reason it is decided to implement the scheme which brings the adjoint pipe parts into steady state before simulation starts. A decisive choice is not made at this point whether the curve fitted polynomial or the lookup table should be implemented. The reason for this is that some imprecision can be accepted if considerable simulation time can be reduced. A test will therefore be performed, in the simulation part of the implementation, to decided which scheme should be utilized.



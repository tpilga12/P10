\section{Linearization}\label{se:linearization}
To be able to obtain a MPC control algorithm the system needs to be transform into state space form. In this section it will be elaborated how this is obtained.


The continuity equation from section \ref{se:hydraulics_of_sewer_line} and an equation to describe the flow knowing the height is used found in appendix \ref{app:formulas}. 
\begin{equation}\label{eq:linearization_Continuity}
\frac{\partial A(x,t)}{\partial t} + \frac{\partial Q(x,t)}{\partial x}=0
\end{equation}

\begin{equation}\label{eq:flow_eq_given_a_height}
	Q = f(h) = \left(0.46-0.5 \cdot cos\left(\pi \frac{h}{d}\right)+0.04\cdot cos\left(2\pi\frac{h}{d}\right)\right)Q_f
\end{equation}

Equation \ref{eq:linearization_Continuity} is expanded to the following:

\begin{equation}
	\frac{\partial A(h)}{\partial h}\frac{\partial h(x,t)}{\partial t} + \frac{\partial Q(h)}{\partial h}\frac{\partial h(x,t)}{\partial x}=0
\end{equation}

By applying the Preissmann scheme from section \ref{se:preissmann_scheme} equation \ref{eq:preissmann_time_derivatie} and \ref{eq:preissmann_space_derivatie} on the partial derivate of h in terms of time and position, the following is obtained: 

\begin{equation}\label{eq:preissmann_skrevet_om}
\begin{aligned}
	&\frac{\partial A(x,t)}{\partial h} \left(\frac{1}{2}\frac{h_{j+1}^{i+1}-h_{j+1}^i}{\Delta t} +  \frac{1}{2} \frac{h_{j}^{i+1} - h_j^i}{\Delta t}\right) + \\ &\frac{\partial Q(x,t)}{\partial h}\left(\theta \frac{h_{j+1}^{i+1}-h_j^{i+1}}{\Delta x}+(1-\theta)\frac{h_{j+1}^i - h_j^i}{\Delta x}\right)=0
\end{aligned}
\end{equation}
Where the derivate of Q given h can be found by taking the derivate of equation \ref{eq:flow_eq_given_a_height} with respect to h, and the the derivate of A can be found by taking the derivate of equation the following equation with the respect to h:
\begin{equation}%\label{eq:calc_area_open_channel}
	A = \frac {d^2}{4} \cdot acos \left(\frac{\frac{d}{2}-h}{\frac{d}{2}}\right)-\sqrt{h\cdot (d-h)}\cdot  \left(\frac{d}{2}-h\right)
\end{equation}

Equation \ref{eq:preissmann_skrevet_om} can be written on matrix form as:

\begin{equation}\label{eq:rearrange_continuity_eq}
\begin{aligned}
	&\begin{bmatrix}
		\underbrace{\frac{1}{2\Delta t}\frac{\partial A}{\partial h}-\frac{\theta}{\Delta x}\frac{\partial Q}{\partial h}}_{a} & \underbrace{\frac{1}{2\Delta t}\frac{\partial A}{\partial h}+\frac{\theta}{\Delta x}\frac{\partial Q}{\partial h}}_{b} 
	\end{bmatrix}
	\begin{bmatrix}
		h_{j}^{i+1} \\
		h_{j+1}^{i+1}
	\end{bmatrix}
	= \\ -
	&\begin{bmatrix}
		\underbrace{\frac{-1}{2\Delta t}\frac{\partial A}{\partial h}-\frac{(1-\theta)}{\Delta x}\frac{\partial Q}{\partial h}}_{c} & \underbrace{\frac{-1}{2\Delta t}\frac{\partial A}{\partial h}+\frac{\theta}{\Delta x}\frac{\partial Q}{\partial h}}_{d} 
	\end{bmatrix}
	\begin{bmatrix}
		h_{j}^{i} \\
		h_{j+1}^{i}
	\end{bmatrix}
	\end{aligned}
\end{equation}

Thereby this equation can be written normal state space form, where the heights are the states of the state space system. 

\begin{equation}
	x(k+1) = Ax(k) + Bu(k) + B_dd
\end{equation}
Where A is the system matrix, x is the state of the system, B is the input matrix and u is the input. By utilizing equation \ref{eq:rearrange_continuity_eq} the following can be wriiten:

\begin{equation}
\begin{aligned}
	   \underbrace{\begin{bmatrix}
	    	1 & 0    & 0    &\cdots &0\\
	    	0 & b_1  & 0    &\cdots &0\\
	    	0 &a_{1} & b_2  &\cdots &\vdots	  \\
	    \vdots&\vdots&\ddots&\ddots & 0  \\
	        0 & 0    &0  	&a_{m-1}&  b_m\\
	   \end{bmatrix}}_{\xi}
	    \underbrace{\begin{bmatrix}
		h_{0}^{i+1}\\
		h_{1}^{i+1} \\
		h_{2}^{i+1} \\			
		\vdots		\\
		h_{m}^{i+1}\\
	\end{bmatrix}}_{\dot{x}}
	=& 
	\underbrace{\begin{bmatrix}
	    	0 &  0   &   0    & \cdots   &0\\
	    c_{0} & d_1  &   0    &  \cdots  &0\\
	    0	  &c_{1} & d_2    & \cdots   &0 \\
	    \vdots&\vdots&\ddots  & \ddots   & \vdots\\
	    0	  & 0    &  0     &  c_{m-1} &  d_m\\
	    \end{bmatrix}}_{A}
	    	\underbrace{\begin{bmatrix}
		h_{0}^{i} \\
		h_{1}^{i} \\
		h_{2}^{i}\\
		\vdots		\\
		h_{m}^{i}\\
		\end{bmatrix}}_{x}
	+ \\ & \underbrace{\begin{bmatrix}
		 1\\
		 -a_0 \\
		 0\\
		 \vdots \\
		 0\\
		\end{bmatrix}}_{B}
		h_m^{i+1}
		% \underbrace{\begin{bmatrix}
		% h_{0}^{i} \\
		% h_{0}^{i+1} \\
		% \end{bmatrix}}_{u}
		+ 
		\underbrace{\begin{bmatrix}
		 \frac{dh}{dQ}\\
		 0 \\
		 0\\
		 \vdots \\
		 0\\
		\end{bmatrix}}_{B_d}
		Qd_{m+1}
	\end{aligned}
\end{equation}
Where m denotes the channel pieces.  
To obtain a state space for the matrix to the left needs to inversed, thereby obtaining the following equation:

\begin{equation}
	\dot{x} = -\xi^{-1} (Ax+Bu)
\end{equation}



\begin{figure}[H]
 \centering
 \input{report/control/tikz/height_input_for_comparision}
\caption{Input height for the simulation.}
\label{fig:height_input_for_comparision}
\end{figure}

\begin{figure}[H]
 \centering
 \input{report/control/tikz/height_output_nonlinear_and_linear_model}
\caption{Output height for the linear and Preissmann scheme simulation.}
\label{fig:height_output_nonlinear_and_linear_model}
\end{figure}
 